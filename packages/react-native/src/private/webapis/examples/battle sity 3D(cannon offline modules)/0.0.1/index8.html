<style>
body {
margin:0;
}
</style>
<canvas id="ctx3d"></canvas>

<canvas id="ctx" style="position:absolute; top:0px;left:0px"></canvas>
<button id="but1"style="position:absolute;top:500px;left:0px">sd</button>
<script src="three.min.js"></script>
<!--<script src="PointerLockControls.js"></script>-->
<script src="GLTFLoader.js"></script>
<script src="cannon.js"></script>
<script src="CannonDebugRenderer.js"></script>
<script>
var width2=window.innerWidth,height2=window.innerHeight;ctx3d.width=width2;ctx3d.height=height2;var ctx=document.getElementById("ctx").getContext("2d");ctx.canvas.width=width2;ctx.canvas.height=height2;window.addEventListener("resize",function(){width2=window.innerWidth;height2=window.innerHeight;ctx3d.width=width2;ctx3d.height=height2;ctx.canvas.width=width2;ctx.canvas.height=height2});
var color_green=new THREE.MeshLambertMaterial({color:3487791}),color_blue=new THREE.MeshBasicMaterial({color:362726}),color_purple=new THREE.MeshBasicMaterial({color:9635302}),gray=new THREE.MeshLambertMaterial({color:"red"}),geometryball=new THREE.SphereGeometry(11,32,32),geometryball2=new THREE.SphereGeometry(.1,10,10),geometryblock=null,ploskost=new THREE.PlaneGeometry(550,550,32,32),nusha=new THREE.Mesh(geometryball,gray),krosh=new THREE.Mesh(geometryball,color_blue),poll=new THREE.Mesh(ploskost,
color_green);poll.rotation.x=-Math.PI/2;nusha.position.y=15;nusha.position.x=115;var rendrer=new THREE.WebGLRenderer({canvas:ctx3d,antialias:!0}),camera=new THREE.PerspectiveCamera(45,width2/height2,.1,5E3);camera.position.set(0,14,10);var scena=new THREE.Scene,light=new THREE.DirectionalLight(16769968,2);light.position.set(0,10,0);scena.add(light);scena.add(light.target);var ambientl=new THREE.AmbientLight(16777215,.5);scena.add(ambientl);scena.add(nusha);scena.add(poll);
var loading_resources=[],sharnir1=new THREE.Mesh(geometryball2,gray);sharnir1.rotation.y=-25*Math.PI/180;scena.add(sharnir1);sharnir1.visible=!1;var sharnir2=new THREE.Mesh(geometryball2,gray);scena.add(sharnir2);sharnir2.visible=!1;sharnir1.add(sharnir2);var cameradot=new THREE.Mesh(geometryball2,gray);cameradot.position.z=15;scena.add(cameradot);cameradot.visible=!1;sharnir2.add(cameradot);var doubletail1=new THREE.Mesh(geometryball2,gray);scena.add(doubletail1);doubletail1.visible=!1;
var doubletail2=new THREE.Mesh(geometryball2,gray);scena.add(doubletail2);doubletail2.visible=!1;var centertankdot=new THREE.Mesh(geometryball2,gray);scena.add(centertankdot);centertankdot.visible=!1;var taildot=new THREE.Mesh(geometryball2,gray);taildot.position.x=5;scena.add(taildot);taildot.visible=!1;centertankdot.add(taildot);var gunshotdot=new THREE.Mesh(geometryball2,gray);gunshotdot.position.x=-15;gunshotdot.rotation.y=-90*Math.PI/180;scena.add(gunshotdot);gunshotdot.visible=!1;
var paybackshot=new THREE.Mesh(geometryball2,gray);scena.add(paybackshot);paybackshot.visible=!1;var glftload=new THREE.GLTFLoader,tank8bit=!1;glftload.load("https://proginvert.github.io/3d_resources/battle_city_tank/mamont_chassis.gltf",function(a){tank8bit=a;a.scene.scale.set(.2,.2,.2);scena.add(a.scene);loading_resources.push(!0)});var tower8bit=!1;
glftload.load("https://proginvert.github.io/3d_resources/battle_city_tank/mamont_tower.gltf",function(a){tower8bit=a;a.scene.position.z=3;a.scene.position.x=2;a.scene.rotation.x=90*Math.PI/180;scena.add(a.scene);loading_resources.push(!0)});var dulo=new THREE.BoxGeometry(2,2,30),stvol=null;glftload.load("https://proginvert.github.io/3d_resources/battle_city_tank/mamont_gun.gltf",function(a){stvol=a;stvol.scene.position.x-=9;stvol.scene.position.y+=2;scena.add(a.scene);loading_resources.push(!0)});
var tree=0;glftload.load("https://proginvert.github.io/3d_resources/battle_sity_map/block/three.gltf",function(a){tree=a.scene;a.scene.scale.set(.2,.2,.2);a.scene.position.y+=1.5;scena.add(a.scene);loading_resources.push(!0)});var brick=0;glftload.load("https://proginvert.github.io/3d_resources/battle_sity_map/block/brick_wall.gltf",function(a){brick=a.scene;a.scene.scale.set(.2,.2,.2);a.scene.position.y+=1.5;scena.add(a.scene);loading_resources.push(!0)});
var blocksize=3.2,fizblocksize=1.6,brickrendlist=[],brickfizlist=[];classtree=function(a,c,d,b){for(var f=a,e=0;e<b;e++){for(var g=0;g<d;g++)tree2=tree.clone(),tree2.position.x=a,tree2.position.z=c,scena.add(tree2),a-=blocksize;a=f;c-=blocksize}};
classbrick=function(a,c,d,b){for(var f=a,e=0;e<b;e++){for(var g=0;g<d;g++){var k=Math.random();brick2=brick.clone();brick2.position.x=a;brick2.position.z=c;brick2.numba2=k;brickrendlist.push(brick2);scena.add(brick2);var h=new CANNON.Body({mass:0,position:new CANNON.Vec3(a,fizblocksize,c),shape:new CANNON.Box(new CANNON.Vec3(fizblocksize,fizblocksize,fizblocksize))});h.numba2=k;brickfizlist.push(h);worldf.addBody(h);a-=blocksize}a=f;c-=blocksize}};var loader=new THREE.CubeTextureLoader,texture=loader.load("https://proginvert.github.io/3d_resources/battle_sity_map/pos-x.jpg https://proginvert.github.io/3d_resources/battle_sity_map/neg-x.jpg https://proginvert.github.io/3d_resources/battle_sity_map/pos-y.jpg https://proginvert.github.io/3d_resources/battle_sity_map/neg-y.jpg https://proginvert.github.io/3d_resources/battle_sity_map/pos-z.jpg https://proginvert.github.io/3d_resources/battle_sity_map/neg-z.jpg".split(" "));
scena.background=texture;var worldf=new CANNON.World;worldf.gravity.set(0,-9.8,0);var groundf=new CANNON.Body({type:CANNON.Body.STATIC,shape:new CANNON.Plane,aaa:83});groundf.quaternion.setFromEuler(-Math.PI/2,0,0);worldf.addBody(groundf);
var radiussperef=1,options={radius:.5,directionLocal:new CANNON.Vec3(0,0,-1),suspensionStiffness:10,suspensionRestLength:.3,frictionSlip:1,dampingRelaxation:2.3,dampingCompression:1.4,maxSuspensionForce:1E5,rollInfluence:.01,axleLocal:new CANNON.Vec3(0,1,0),chassisConnectionPointLocal:new CANNON.Vec3(1,1,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-3,useCustomSlidingRotationalSpeed:!0},cubeBody=new CANNON.Body({mass:150,position:new CANNON.Vec3(0,9,-150),shape:new CANNON.Box(new CANNON.Vec3(3.5,
1.7,.5))}),cubeBody2=new CANNON.Body({mass:1,position:new CANNON.Vec3(5,5,5),shape:new CANNON.Box(new CANNON.Vec3(1,5,5))});worldf.addBody(cubeBody2);var tank=new CANNON.RaycastVehicle({chassisBody:cubeBody});cubeBody2.addEventListener("collide",function(a){attach_tank_parts&&console.log(a.body.mass)});options.chassisConnectionPointLocal.set(2.5,1,-.5);tank.addWheel(options);options.chassisConnectionPointLocal.set(2.5,-1,-.5);tank.addWheel(options);options.chassisConnectionPointLocal.set(-2.5,1,-.5);
tank.addWheel(options);options.chassisConnectionPointLocal.set(-2.5,-1,-.5);tank.addWheel(options);tank.addToWorld(worldf);
for(var wheelBodies=[],i=0;i<tank.wheelInfos.length;i++){var wheel=tank.wheelInfos[i],cylinderShape=new CANNON.Cylinder(wheel.radius,wheel.radius,wheel.radius/2,20),wheelBody=new CANNON.Body({mass:0});wheelBody.type=CANNON.Body.KINEMATIC;wheelBody.collisionFilterGroup=0;var q=new CANNON.Quaternion;q.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI/2);wheelBody.addShape(cylinderShape,new CANNON.Vec3,q);wheelBodies.push(wheelBody);worldf.addBody(wheelBody)}tank.chassisBody.quaternion.x-=90*Math.PI/180;
var collisionmodel=new THREE.CannonDebugRenderer(scena,worldf);document.onmousedown=function(a){};var isLocked=!1;but1.onclick=function(a){ctx3d.requestPointerLock();isLocked=!0};document.onmousemove=function(a){if(!1!==isLocked){var c=a.movementY||a.mozMovementY||a.webkitMovementY||0;sharnir1.rotation.y-=.002*(a.movementX||a.mozMovementX||a.webkitMovementX||0);sharnir2.rotation.x-=.002*c}};var towerstop=!1;
document.onmousedown=function(a){3===a.which&&(towerstop=!0);if(1===a.which&&!0===isLocked){shot.play();var c=new THREE.Vector3;gunshotdot.getWorldPosition(c);a=c.x;var d=c.y;c=c.z;var b=new CANNON.Body({mass:1.01});b.addShape(ballShape);b.lifetime=200;var f=new THREE.Mesh(ballGeometry,new THREE.MeshLambertMaterial({color:14540253}));worldf.add(b);scena.add(f);f.castShadow=!0;f.receiveShadow=!0;var e=Math.random();snaryadi.push(b);snaryadi.numba=e;snaryadi2.push(f);snaryadi2.numba=e;e=shootDirection;
shootDirection.set(0,0,1);shootDirection2.set(0,0,1);new THREE.Ray(tank.chassisBody.position,e.sub(tank.chassisBody.position).normalize());shootDirection.copy(gunshotdot.getWorldDirection());shootDirection2.copy(paybackshot.getWorldDirection());tank.chassisBody.angularVelocity.set(1*shootDirection2.x,1*shootDirection2.y,1*shootDirection2.z);b.velocity.set(shootDirection.x*shootVelo,shootDirection.y*shootVelo,shootDirection.z*shootVelo);a+=shootDirection.x*(1.02*sphereShape.radius+ballShape.radius);
d+=shootDirection.y*(1.02*sphereShape.radius+ballShape.radius);c+=shootDirection.z*(1.02*sphereShape.radius+ballShape.radius);b.position.set(a,d,c);f.position.set(a,d,c)}};document.onmouseup=function(a){3===a.which&&(towerstop=!1)};document.addEventListener?"onwheel"in document?document.addEventListener("wheel",onWheel):"onmousewheel"in document?document.addEventListener("mousewheel",onWheel):document.addEventListener("MozMousePixelScroll",onWheel):document.attachEvent("onmousewheel",onWheel);
function onWheel(a){a=a||window.event;cameradot.position.z+=(a.deltaY||a.detail||a.wheelDelta)/100}var listener=new THREE.AudioListener;camera.add(listener);var sound=new THREE.PositionalAudio(listener),shot=new THREE.PositionalAudio(listener),engine=new THREE.PositionalAudio(listener),audioLoader=new THREE.AudioLoader;audioLoader.load("https://proginvert.github.io/3d_resources/aud/shot.wav",function(a){shot.setBuffer(a);shot.setLoop(!1);shot.setVolume(1);shot.setRefDistance(1);loading_resources.push(!0)});
audioLoader.load("https://proginvert.github.io/3d_resources/aud/engine.wav",function(a){engine.setBuffer(a);engine.setLoop(!0);engine.setVolume(5);engine.setRefDistance(1);loading_resources.push(!0)});audioLoader.load("https://proginvert.github.io/3d_resources/aud/Untitled.ogg",function(a){sound.setBuffer(a);sound.setLoop(!0);sound.setVolume(1);sound.setRefDistance(1);loading_resources.push(!0)});nusha.add(sound);
var snaryadi=[],snaryadi2=[],ballShape=new CANNON.Sphere(.2),ballGeometry=new THREE.SphereGeometry(ballShape.radius,32,32),shootDirection=new THREE.Vector3,shootDirection2=new THREE.Vector3,shootVelo=150,sphereShape=new CANNON.Sphere(1.3),goforward=!1,goback=!1,goleft=!1,gogight=!1,rendercollision=!0;
document.onkeydown=function(a){"ArrowUp"===a.code&&(goforward=!0);"ArrowDown"===a.code&&(goback=!0);"ArrowLeft"===a.code&&(goleft=!0);"ArrowRight"===a.code&&(gogight=!0);"KeyF"===a.code&&worldf.gravity.set(0,-9.8,-15);"KeyG"===a.code&&(worldf.gravity.set(0,-9.8,0),sound.play(),engine.play());"KeyJ"===a.code&&(rendercollision=!1);"KeyR"===a.code&&tower8bit.scene.rotateZ(.01);"KeyT"===a.code&&tower8bit.scene.rotateZ(-.01);"KeyY"===a.code&&stvol.scene.rotateY(.01);"KeyU"===a.code&&stvol.scene.rotateY(-.01);
"Escape"===a.code&&(isLocked=!1)};document.onkeyup=function(a){"ArrowUp"===a.code&&(goforward=!1);"ArrowDown"===a.code&&(goback=!1);"ArrowLeft"===a.code&&(goleft=!1);"ArrowRight"===a.code&&(gogight=!1)};var attach_tank_parts=!1;
setInterval(function(){if(!1===attach_tank_parts){for(var a=!0,c=0;8>c;c++)if(console.log(c),!0!==loading_resources[c]){a=!1;break}!0===a&&(tank8bit.scene.add(engine),doubletail1.position.x=25,doubletail1.position.y=-2,tank8bit.scene.add(doubletail1),doubletail2.position.x=25,doubletail2.position.y=2,tank8bit.scene.add(doubletail2),tank8bit.scene.add(tower8bit.scene),tower8bit.scene.add(stvol.scene),stvol.scene.add(shot),stvol.scene.add(gunshotdot),paybackshot.rotation.y=-90*Math.PI/180,gunshotdot.add(paybackshot),
classtree(0,-150,10,2),classbrick(0,-160,10,2),brickfizlist[0].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[0])}),brickfizlist[1].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[1])}),brickfizlist[2].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[2])}),brickfizlist[3].addEventListener("collide",function(b){console.log(b.body.mass);
1.01===b.body.mass&&worldf.remove(brickfizlist[3])}),brickfizlist[4].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[4])}),brickfizlist[5].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[5])}),brickfizlist[6].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[6])}),brickfizlist[7].addEventListener("collide",function(b){console.log(b.body.mass);
1.01===b.body.mass&&worldf.remove(brickfizlist[7])}),brickfizlist[8].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[8])}),brickfizlist[9].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[9])}),brickfizlist[10].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[10])}),brickfizlist[11].addEventListener("collide",function(b){console.log(b.body.mass);
1.01===b.body.mass&&worldf.remove(brickfizlist[11])}),brickfizlist[12].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[12])}),brickfizlist[13].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[13])}),brickfizlist[14].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[14])}),brickfizlist[15].addEventListener("collide",
function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[15])}),brickfizlist[16].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[16])}),brickfizlist[17].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[17])}),brickfizlist[18].addEventListener("collide",function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[18])}),brickfizlist[19].addEventListener("collide",
function(b){console.log(b.body.mass);1.01===b.body.mass&&worldf.remove(brickfizlist[19])}),attach_tank_parts=!0)}else{ctx.clearRect(0,0,width2,height2);ctx.fillStyle="white";ctx.fillRect(130,30,35,35);for(c=0;c<snaryadi.length;c++)if(snaryadi[c].lifetime--,0>snaryadi[c].lifetime){for(a=0;a<snaryadi2.length;a++)snaryadi2[a]&&snaryadi[c].numba===snaryadi2[a].numba&&(scena.remove(snaryadi2[a]),snaryadi2[a]=void 0,delete snaryadi2[a]);worldf.remove(snaryadi[c])}for(c=0;c<snaryadi2.length;c++)snaryadi2[c]&&
(snaryadi2[c].position.copy(snaryadi[c].position),snaryadi2[c].quaternion.copy(snaryadi[c].quaternion));for(c=0;c<tank.wheelInfos.length;c++){tank.updateWheelTransform(c);a=tank.wheelInfos[c].worldTransform;var d=wheelBodies[c];d.position.copy(a.position);d.quaternion.copy(a.quaternion)}!1===towerstop&&(doubletail1pos=new THREE.Vector3,doubletail1.getWorldPosition(doubletail1pos),doubletail2pos=new THREE.Vector3,doubletail2.getWorldPosition(doubletail2pos),taildotpos=new THREE.Vector3,taildot.getWorldPosition(taildotpos),
taildotpos.distanceTo(doubletail1pos)<taildotpos.distanceTo(doubletail2pos)-.05&&(centertankdot.rotation.y+=.01),taildotpos.distanceTo(doubletail1pos)>taildotpos.distanceTo(doubletail2pos)+.05&&(centertankdot.rotation.y-=.01),tower8bit.scene.rotation.y<sharnir1.rotation.y-centertankdot.rotation.y-1.5707963267948966&&(tower8bit.scene.rotation.y+=.01),tower8bit.scene.rotation.y>sharnir1.rotation.y-centertankdot.rotation.y-1.5707963267948966&&(tower8bit.scene.rotation.y-=.01),-stvol.scene.rotation.z<
sharnir2.rotation.x&&(stvol.scene.rotation.z-=.01),-stvol.scene.rotation.z>sharnir2.rotation.x&&(stvol.scene.rotation.z+=.01),8<180*stvol.scene.rotation.z/Math.PI&&(stvol.scene.rotation.z=8*Math.PI/180),-15>180*stvol.scene.rotation.z/Math.PI&&(stvol.scene.rotation.z=-15*Math.PI/180));c=100*(8-Math.sqrt(Math.pow(tank.chassisBody.velocity.x,2)+Math.pow(tank.chassisBody.velocity.z,2)));!0===goforward&&!1===goback&&!1===goleft&&!1===gogight&&0>tank.wheelInfos[0].deltaRotation?(tank.applyEngineForce(c,
0),tank.applyEngineForce(c,1),tank.applyEngineForce(c,2),tank.applyEngineForce(c,3)):!1===goforward&&!0===goback&&!1===goleft&&!1===gogight&&0<tank.wheelInfos[0].deltaRotation?(tank.applyEngineForce(-c/8,0),tank.applyEngineForce(-c/8,1),tank.applyEngineForce(-c/8,2),tank.applyEngineForce(-c/8,3)):!0===goforward&&!1===goback&&!1===goleft&&!1===gogight&&0<tank.wheelInfos[0].deltaRotation?(tank.applyEngineForce(800,0),tank.applyEngineForce(800,1),tank.applyEngineForce(800,2),tank.applyEngineForce(800,
3)):!1===goforward&&!0===goback&&!1===goleft&&!1===gogight&&0>tank.wheelInfos[0].deltaRotation?(tank.applyEngineForce(-800,0),tank.applyEngineForce(-800,1),tank.applyEngineForce(-800,2),tank.applyEngineForce(-800,3)):!0===goleft&&!1===gogight?(tank.applyEngineForce(1E4,0),tank.applyEngineForce(-1E4,1),tank.applyEngineForce(1E4,2),tank.applyEngineForce(-1E4,3)):!1===goleft&&!0===gogight?(tank.applyEngineForce(-1E4,0),tank.applyEngineForce(1E4,1),tank.applyEngineForce(-1E4,2),tank.applyEngineForce(1E4,
3)):(tank.applyEngineForce(0,0),tank.applyEngineForce(0,1),tank.applyEngineForce(0,2),tank.applyEngineForce(0,3));worldf.step(1/60);cameradotpos=new THREE.Vector3;cameradot.getWorldPosition(cameradotpos);camera.position.set(cameradotpos.x,cameradotpos.y,cameradotpos.z);camera.lookAt(sharnir1.position.x,sharnir1.position.y,sharnir1.position.z);tank8bit.scene.position.x=tank.chassisBody.position.x;tank8bit.scene.position.y=tank.chassisBody.position.y;tank8bit.scene.position.z=tank.chassisBody.position.z;
sharnir1.position.x=tank.chassisBody.position.x;sharnir1.position.y=tank.chassisBody.position.y+4;sharnir1.position.z=tank.chassisBody.position.z;centertankdot.position.x=tank.chassisBody.position.x;centertankdot.position.y=tank.chassisBody.position.y;centertankdot.position.z=tank.chassisBody.position.z;tank8bit.scene.quaternion.x=tank.chassisBody.quaternion.x;tank8bit.scene.quaternion.y=tank.chassisBody.quaternion.y;tank8bit.scene.quaternion.z=tank.chassisBody.quaternion.z;tank8bit.scene.quaternion.w=
tank.chassisBody.quaternion.w;rendrer.render(scena,camera)}},1E3/60);
</script>